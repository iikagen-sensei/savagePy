{% extends "ui/base.html" %}

{% block title %}{{ 'Editar' if record_id else 'Nueva' }} regla ¬∑ Savage Worlds{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://unpkg.com/easymde/dist/easymde.min.css">
<style>
  .emoji-wrap { position:relative; display:flex; align-items:center; gap:0.5rem; }
  .emoji-preview { font-size:2rem; width:44px; height:44px; display:flex; align-items:center; justify-content:center; border:1px solid var(--border); background:var(--bg); cursor:pointer; flex-shrink:0; }
  .emoji-preview:hover { border-color:var(--red); }
  .emoji-input { flex:1; font-size:1.1rem; }
  .emoji-picker-wrap { position:absolute; top:calc(100% + 4px); left:0; z-index:200; display:none; }
  .emoji-picker-wrap.open { display:block; }
  em-emoji-picker { --border-radius:0; --category-icon-size:18px; height:350px; }
</style>
{% endblock %}

{% block header_extra %}
<div class="hero">
  <div class="hero-inner">
    <div class="hero-eyebrow">Reglas modulares</div>
    <h1>{{ 'Editar' if record_id else 'Nueva' }} <strong>regla</strong></h1>
  </div>
</div>
<div class="save-bar">
  <span class="save-bar-title">{{ rule.name if rule and rule.name else 'Nueva regla' }}</span>
  <div class="save-bar-actions">
    <a class="btn btn-ghost" href="/rules">‚Üê Volver</a>
    <button class="btn btn-solid" onclick="document.getElementById('ruleForm').submit()">Guardar</button>
  </div>
</div>
{% endblock %}

{% block body %}
<form id="ruleForm" method="POST" action="/rules/save">
  <input type="hidden" name="record_id" value="{{ record_id or '' }}">
  <input type="hidden" name="reference_book_id" id="referenceBookId"
         value="{{ rule.reference_book.Id if rule and rule.reference_book else '' }}">

  <div class="form-layout">

    <!-- ‚îÄ‚îÄ CUERPO ‚îÄ‚îÄ -->
    <div class="form-sections">

      <div class="section">
        <div class="section-header form-section-head">Descripci√≥n breve</div>
        <div class="section-body form-section-body">
          <input class="form-input" type="text" name="description"
                 value="{{ rule.description or '' if rule else '' }}"
                 placeholder="Una l√≠nea describiendo la regla" style="width:100%">
        </div>
      </div>

      <div class="section">
        <div class="section-header form-section-head">Contenido</div>
        <div class="section-body form-section-body">
          <textarea name="content" id="editor">{{ rule.content or '' if rule else '' }}</textarea>
        </div>
      </div>

    </div>

    <!-- ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ -->
    <div class="form-sidebar">

      <div class="sidebar-panel">
        <div class="sidebar-panel-head">Datos b√°sicos</div>
        <div class="sidebar-panel-body">

          <div class="field">
            <label>Nombre *</label>
            <input class="form-input" type="text" name="name"
                   value="{{ rule.name or '' if rule else '' }}" required style="width:100%">
          </div>

          <div class="field" style="margin-top:0.8rem">
            <label>Nombre original</label>
            <input class="form-input" type="text" name="name_original"
                   value="{{ rule.name_original or '' if rule else '' }}" style="width:100%">
          </div>

          <div class="field" style="margin-top:0.8rem">
            <label>Origen</label>
            <select class="form-input" name="source" id="sourceSelect" style="width:100%"
                    onchange="toggleRefFields()">
              {% for opt in ['Oficial', 'Terceros', 'Propio'] %}
              <option value="{{ opt }}" {% if rule and rule.source == opt %}selected{% endif %}>{{ opt }}</option>
              {% endfor %}
            </select>
          </div>

          <div id="refBookField" style="margin-top:0.8rem; display:none">
            <label class="field">Libro de referencia</label>
            <select class="form-input" id="refBookSelect" style="width:100%; margin-top:0.3rem"
                    onchange="document.getElementById('referenceBookId').value=this.value">
              <option value="">‚Äî Sin libro ‚Äî</option>
            </select>
          </div>

          <div class="field" id="pageNoField" style="margin-top:0.8rem; display:none">
            <label>P√°gina</label>
            <input class="form-input" type="text" name="page_no"
                   value="{{ rule.page_no or '' if rule else '' }}" style="width:80px">
          </div>

        </div>
      </div>

      <div class="sidebar-panel">
        <div class="sidebar-panel-head">Icono</div>
        <div class="sidebar-panel-body">
          <div class="emoji-wrap" id="emojiWrap">
            <div class="emoji-preview" id="emojiPreview" onclick="togglePicker()">{{ rule.icon if rule and rule.icon else 'üìú' }}</div>
            <input class="form-input emoji-input" type="text" name="icon" id="emojiInput"
                   value="{{ rule.icon or '' if rule and rule.icon else '' }}"
                   placeholder="üìú" maxlength="4"
                   oninput="document.getElementById('emojiPreview').textContent=this.value||'üìú'">
            <div class="emoji-picker-wrap" id="emojiPicker"></div>
          </div>
        </div>
      </div>

    </div>
  </div>
</form>
{% endblock %}

{% block scripts %}
<script type="module" src="https://cdn.jsdelivr.net/npm/emoji-mart@5/dist/browser.js"></script>
<script src="https://unpkg.com/easymde/dist/easymde.min.js"></script>
<script>
new EasyMDE({
  element: document.getElementById('editor'),
  spellChecker: false,
  autosave: { enabled: false },
  toolbar: [
    'bold', 'italic', '|',
    'heading-2', 'heading-3', '|',
    'unordered-list', 'ordered-list', '|',
    'table', '|',
    'preview', 'side-by-side', 'fullscreen'
  ],
  minHeight: '400px',
});

// ‚îÄ‚îÄ Libros de referencia ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const CURRENT_BOOK_ID = {{ (rule.reference_book.Id | string) if rule and rule.reference_book else 'null' }};
let books = [];

async function loadBooks() {
  try {
    const res = await fetch('/api/form-data/rules');
    const data = await res.json();
    books = data.books || [];
    const sel = document.getElementById('refBookSelect');
    books.forEach(b => {
      const opt = document.createElement('option');
      opt.value = b.Id;
      opt.textContent = b.title + (b.description ? ` ‚Äî ${b.description}` : '');
      if (b.Id === CURRENT_BOOK_ID) opt.selected = true;
      sel.appendChild(opt);
    });
    if (CURRENT_BOOK_ID) {
      document.getElementById('referenceBookId').value = CURRENT_BOOK_ID;
    }
  } catch(e) {
    console.error('Error cargando libros:', e);
  }
}

function toggleRefFields() {
  const source = document.getElementById('sourceSelect').value;
  const showRef = source === 'Oficial' || source === 'Terceros';
  document.getElementById('refBookField').style.display = showRef ? '' : 'none';
  document.getElementById('pageNoField').style.display  = showRef ? '' : 'none';
}

loadBooks();
toggleRefFields();

// ‚îÄ‚îÄ Emoji picker ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let pickerInstance = null;

function togglePicker() {
  const wrap = document.getElementById('emojiPicker');
  if (wrap.classList.contains('open')) { closePicker(); return; }
  if (!pickerInstance) {
    pickerInstance = new EmojiMart.Picker({
      onEmojiSelect: (emoji) => {
        document.getElementById('emojiInput').value = emoji.native;
        document.getElementById('emojiPreview').textContent = emoji.native;
        closePicker();
      },
      theme: 'light',
      set: 'native',
      locale: 'en',
      previewPosition: 'none',
      skinTonePosition: 'none',
    });
    wrap.appendChild(pickerInstance);
  }
  wrap.classList.add('open');
}

function closePicker() {
  document.getElementById('emojiPicker').classList.remove('open');
}

document.addEventListener('click', e => {
  if (!document.getElementById('emojiWrap').contains(e.target)) closePicker();
});
</script>
{% endblock %}
